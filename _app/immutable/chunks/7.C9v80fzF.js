import{s as ae,b as re,o as ie,A as ce,e as q}from"./scheduler.BXvgzZK-.js";import{S as fe,i as ue,e as A,c as D,d as H,g as v,r as k,j as B,k as y,A as he,v as le,t as N,a as G,b as T,s as V,f as C,h as W,z as F,l as se,x as ne,G as L,m as _e,n as pe,o as de,p as me}from"./index.BQ0Ppj1p.js";import{e as S,u as ge,o as ye,a as oe}from"./public.DaMEbo7N.js";import{g as we,a as ve}from"./obr-host.CvGELXpw.js";import{a as be,b as ke,R as Ie,g as U}from"./roll-formula.BB4CBsVT.js";function J(i,e,s){const l=i.slice();return l[19]=e[s],l}function K(i,e,s){const l=i.slice();return l[22]=e[s],l}function Q(i,e,s){const l=i.slice();return l[22]=e[s],l}function Y(i){let e,s;return e=new Ie({props:{roll:i[22]}}),{c(){_e(e.$$.fragment)},l(l){pe(e.$$.fragment,l)},m(l,h){de(e,l,h),s=!0},p(l,h){const f={};h&1&&(f.roll=l[22]),e.$set(f)},i(l){s||(N(e.$$.fragment,l),s=!0)},o(l){G(e.$$.fragment,l),s=!1},d(l){me(e,l)}}}function Z(i){let e,s=U(i[22])+"",l,h;return{c(){e=A("span"),l=T(s),h=V(),this.h()},l(f){e=D(f,"SPAN",{class:!0});var u=H(e);l=C(u,s),h=W(u),u.forEach(v),this.h()},h(){k(e,"class","total svelte-uyfwtr")},m(f,u){B(f,e,u),y(e,l),y(e,h)},p(f,u){u&1&&s!==(s=U(f[22])+"")&&se(l,s)},d(f){f&&v(e)}}}function $(i,e){let s,l,h,f=e[4][e[19].playerId].name+"",u,m,I,p,g,o,r,_,E,P,w=S(e[19].rolls),c=[];for(let a=0;a<w.length;a+=1)c[a]=Y(Q(e,w,a));const z=a=>G(c[a],1,1,()=>{c[a]=null});let j=S(e[19].rolls),d=[];for(let a=0;a<j.length;a+=1)d[a]=Z(K(e,j,a));return{key:i,first:null,c(){s=A("div"),l=A("span"),h=A("span"),u=T(f),m=T(`
                rolled`),I=V(),p=A("span"),g=A("span");for(let a=0;a<c.length;a+=1)c[a].c();o=T(`
                    =`),r=V(),_=A("span");for(let a=0;a<d.length;a+=1)d[a].c();E=V(),this.h()},l(a){s=D(a,"DIV",{class:!0});var n=H(s);l=D(n,"SPAN",{class:!0});var t=H(l);h=D(t,"SPAN",{class:!0});var b=H(h);u=C(b,f),b.forEach(v),m=C(t,`
                rolled`),t.forEach(v),I=W(n),p=D(n,"SPAN",{class:!0});var R=H(p);g=D(R,"SPAN",{class:!0});var M=H(g);for(let O=0;O<c.length;O+=1)c[O].l(M);o=C(M,`
                    =`),M.forEach(v),r=W(R),_=D(R,"SPAN",{class:!0});var X=H(_);for(let O=0;O<d.length;O+=1)d[O].l(X);X.forEach(v),R.forEach(v),E=W(n),n.forEach(v),this.h()},h(){k(h,"class","player svelte-uyfwtr"),k(l,"class","lead svelte-uyfwtr"),k(g,"class","formulas svelte-uyfwtr"),k(_,"class","results"),k(p,"class","body svelte-uyfwtr"),F(p,"critical",e[19].rolls.some(e[8])),k(s,"class","entry svelte-uyfwtr"),this.first=s},m(a,n){B(a,s,n),y(s,l),y(l,h),y(h,u),y(l,m),y(s,I),y(s,p),y(p,g);for(let t=0;t<c.length;t+=1)c[t]&&c[t].m(g,null);y(g,o),y(p,r),y(p,_);for(let t=0;t<d.length;t+=1)d[t]&&d[t].m(_,null);y(s,E),P=!0},p(a,n){if(e=a,(!P||n&17)&&f!==(f=e[4][e[19].playerId].name+"")&&se(u,f),n&1){w=S(e[19].rolls);let t;for(t=0;t<w.length;t+=1){const b=Q(e,w,t);c[t]?(c[t].p(b,n),N(c[t],1)):(c[t]=Y(b),c[t].c(),N(c[t],1),c[t].m(g,o))}for(ne(),t=w.length;t<c.length;t+=1)z(t);le()}if(n&1){j=S(e[19].rolls);let t;for(t=0;t<j.length;t+=1){const b=K(e,j,t);d[t]?d[t].p(b,n):(d[t]=Z(b),d[t].c(),d[t].m(_,null))}for(;t<d.length;t+=1)d[t].d(1);d.length=j.length}(!P||n&1)&&F(p,"critical",e[19].rolls.some(e[8]))},i(a){if(!P){for(let n=0;n<w.length;n+=1)N(c[n]);P=!0}},o(a){c=c.filter(Boolean);for(let n=0;n<c.length;n+=1)G(c[n]);P=!1},d(a){a&&v(s),L(c,a),L(d,a)}}}function Ee(i){let e,s,l=[],h=new Map,f,u,m,I,p=S(Object.values(i[0]));const g=o=>o[19].rollId;for(let o=0;o<p.length;o+=1){let r=J(i,p,o),_=g(r);h.set(_,l[o]=$(_,r))}return{c(){e=A("div"),s=A("div");for(let o=0;o<l.length;o+=1)l[o].c();this.h()},l(o){e=D(o,"DIV",{class:!0,style:!0});var r=H(e);s=D(r,"DIV",{class:!0});var _=H(s);for(let E=0;E<l.length;E+=1)l[E].l(_);_.forEach(v),r.forEach(v),this.h()},h(){k(s,"class","history svelte-uyfwtr"),k(e,"class","component svelte-uyfwtr"),k(e,"style",f=Object.entries(i[1]).map(te).join(";"))},m(o,r){B(o,e,r),y(e,s);for(let _=0;_<l.length;_+=1)l[_]&&l[_].m(s,null);i[9](s),i[11](e),u=!0,m||(I=he(e,"click",i[10]),m=!0)},p(o,[r]){r&17&&(p=S(Object.values(o[0])),ne(),l=ge(l,r,g,1,o,p,h,s,ye,$,null,J),le()),(!u||r&2&&f!==(f=Object.entries(o[1]).map(te).join(";")))&&k(e,"style",f)},i(o){if(!u){for(let r=0;r<p.length;r+=1)N(l[r]);u=!0}},o(o){for(let r=0;r<l.length;r+=1)G(l[r]);u=!1},d(o){o&&v(e);for(let r=0;r<l.length;r+=1)l[r].d();i[9](null),i[11](null),m=!1,I()}}}const x=`${oe}/roll-popover`,Pe=.1,ee=132,Ae=512,te=([i,e])=>`${i}: ${e}`;function De(i,e,s){let l;const h=we(),f=ve();re(i,f,n=>s(4,l=n));let{displayDelay:u=7e3}=e,m={},I=null,p={},g,o;function r(n){const t=Date.now();let b=!!n;for(const[R,M]of Object.entries(m))M.when+u<t&&(b=!0,delete m[R]);b&&(s(0,m),Object.keys(m).length!==0?E():P())}ie(()=>{I=setInterval(()=>{r(),_()},100),h.broadcast.onMessage(oe,n=>{if(!be(n))return;const{data:t}=n;t.imported||(s(0,m[t.rollId]={playerId:t.playerId,rollId:t.rollId,rolls:t.rolls,when:t.when},m),r(!0))})}),ce(()=>{I&&clearInterval(I)});async function _(){Object.keys(m).length===0?await w(0,0):window.window.innerWidth&&g.scrollHeight<Ae&&await w(window.window.innerWidth,Math.max(ee,g.scrollHeight+10))}async function E(){w(384,ee)}async function P(){return w(0,0)}async function w(n,t){t!==window.window.innerHeight&&(t<window.window.innerHeight&&Object.keys(m).length||(await Promise.all([h.popover.setWidth(x,n),h.popover.setHeight(x,t)]),s(3,o.scrollTop=o.scrollHeight,o)))}async function c(){s(0,m={}),P()}const z=n=>ke(n);function j(n){q[n?"unshift":"push"](()=>{g=n,s(2,g)})}const d=()=>c();function a(n){q[n?"unshift":"push"](()=>{o=n,s(3,o)})}return i.$$set=n=>{"displayDelay"in n&&s(7,u=n.displayDelay)},i.$$.update=()=>{if(i.$$.dirty&128){const n=u*(1-Pe);s(1,p={"--disappear-delay":`${n}ms`})}},[m,p,g,o,l,f,c,u,z,j,d,a]}class Me extends fe{constructor(e){super(),ue(this,e,De,Ee,ae,{displayDelay:7})}}export{x as P,Me as a};
